---
title: "Export von militärisch verwendbaren Gütern"
author: "SRF Data, Timo Grossenbacher (timo.grossenbacher@srf.ch)"
date: "Dezember 2017"
output:
  html_document:
    code_folding: show
    echo: TRUE
    warning: FALSE
    message: FALSE
    theme: simplex
    df_print: kable
    toc: yes
    toc_depth: 4
    toc_float: 
      collapsed: false
      smooth_scroll: false
subtitle: Vorprozessierung und Analyse
---

```{r, echo=FALSE}
# CONFIG
user_name <- "srfdata" # github user name
project_name <- "2018-01-dual-use" # adapt to new repo name
package_date <- "2017-09-01" # date of the CRAN snapshot that
# the checkpoint package uses
R_version <- "3.4.4" # R-Version to use
options(Ncpus = 4) # use 4 cores for parallelized installation of packages
if (R_version != paste0(version$major, ".", version$minor)){
  stop("ERROR: specified R version does not match currently used.")
}
```


### Vorbemerkungen

Dieses Dokument beschreibt die Vorprozessierung und explorative Analyse des Datensatzes, der unter [srf.ch interaktiv visualisiert](https://www.srf.ch/news/schweiz/imsi-catcher-fuer-indonesien-ueberwachungstechnik-aus-der-schweiz-fuer-heikle-laender) und unter [diesem Link](https://www.srf.ch/static/srf-data/data/2018/seco-dual-use/data/seco_dual_use.csv) als CSV-Datei zum Download angeboten wird.

SRF Data legt Wert darauf, dass die Datenvorprozessierung und -Analyse nachvollzogen und überprüft werden kann. SRF Data glaubt an das Prinzip offener Daten, aber auch offener und nachvollziehbarer Methoden. Zum anderen soll es Dritten ermöglicht werden, auf dieser Vorarbeit aufzubauen und damit weitere Auswertungen oder Applikationen zu generieren.  

Die Vorprozessierung und Analyse wurde im Statistikprogramm R vorgenommen. Die Endprodukte des verwendeten Scripts sind:

* `output/seco_dual_use_for_vis.csv`: Wird für die Visualisierung verwendet, reduzierte Menge von Attributen
* `output/seco_dual_use.csv`: Vollständiger Datensatz, der zum Download angeboten wird. Dieser Datensatz wird im folgenden Kapitel beschrieben. 

### R-Script & Daten

Die Vorprozessierung und Analyse wurde im Statistikprogramm R vorgenommen. Das zugrunde liegende Script sowie die prozessierten Daten können unter [diesem Link](https://srfdata.github.io/`r project_name`/rscript.zip) heruntergeladen werden. Durch Ausführen von `main.Rmd` kann der hier beschriebene Prozess nachvollzogen und der für den Artikel verwendete Datensatz generiert werden. Dabei werden Daten aus dem Ordner `input` eingelesen und Ergebnisse in den Ordner `output` geschrieben. 

SRF Data verwendet das [rddj-template](https://github.com/grssnbchr/rddj-template) von Timo Grossenbacher als Grundlage für seine R-Scripts.  Entstehen bei der Ausführung dieses Scripts Probleme, kann es helfen, die Anleitung von [rddj-template](https://github.com/grssnbchr/rddj-template) zu studieren. 

Debug-Informationen: *This report was generated on `r Sys.time()`. R version: `r paste0(version$major, ".", version$minor)` on `r version$platform`. For this report, CRAN packages as of `r package_date` were used.*

### GitHub

Der Code für die vorliegende Datenprozessierung ist auf [https://github.com/srfdata/`r project_name`](https://github.com/srfdata/`r project_name`) zur freien Verwendung verfügbar. 

### Lizenz

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Dataset" property="dct:title" rel="dct:type">`r project_name`</span> von <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/srfdata/`r project_name`" property="cc:attributionName" rel="cc:attributionURL">SRF Data</a> ist lizenziert unter einer <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Namensnennung - Weitergabe unter gleichen Bedingungen 4.0 International Lizenz</a>.

#### Weitere Projekte

Code & Daten von [SRF Data](http://srf.ch/data) sind unter [https://srfdata.github.io](https://srfdata.github.io) verfügbar.

#### Haftungsausschluss

Die veröffentlichten Informationen sind sorgfältig zusammengestellt, erheben aber keinen Anspruch auf Aktualität, Vollständigkeit oder Richtigkeit. Es wird keine Haftung übernommen für Schäden, die  durch die Verwendung dieses Scripts oder der daraus gezogenen Informationen entstehen. Dies gilt ebenfalls für Inhalte Dritter, die über dieses Angebot zugänglich sind. 

### Datenbeschreibung `seco_dual_use.csv`

| Attribut | Typ | Beschreibung | 
|----------------------|--------------------|-------------------------------------|
| (Erste Spalte, keine Bezeichnung)  | Integer  | Identifikator, eindeutig.    |
|  GN  |  Integer |   Geschäftsnummer in der Seco-Datenbank, zwei unterschiedliche Formate je nach *Herkunfstdatei*.   |
|    UnterGN  |    Integer |     Durchnummerierung von Geschäften mit gleicher *GN*.   |
|    Datum  |    Date |     Datum der Bewilligung im Format YYYY-MM-DD. Ab 2016 nur noch jeweils der erste Tag des Quartals, in dem die Bewilligung erteilt wurde |
|    Land  |    String |     Land, in das die Güter exportiert werden.  |
|    Wert  |    Float |     Wert der Güter in Schweizer Franken.   |
|    Verzeichnis  |    String |     Kürzel für Verzeichnis, siehe unten.   |
|    Signatur  |    String |     Code, der die Kategorie/Art der gehandelten Güter kodiert, aufgeschlüsselt in *Haupttyp*, *Untertyp*, *Zusatz*, siehe Beispiel unten. Achtung: Es kann sein, dass ein Geschäft zwei Signaturen aufweist. Dann wird nur die erste zur Ermittelung der Teilsignaturen verwendet.   |
|    Haupttyp  |    String |     Erste Hierarchiestufe der *Signatur*, entspricht Überkategorien in den einzelnen *Verzeichnis*sen.  |
|    Untertyp  |    String |     Zweite Hierarchiestufe der *Signatur*, entspricht Unterkategorien in den einzelnen *Verzeichnis*sen. |
|    Zusatz  |    String |     Rest der *Signatur*.  |
|    Herkunftsdatei  |    String |     Originaldatei auf [der Website des SECO](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html)  |

#### Attribut *Verzeichnis*

Folgende Werte sind möglich:

* 5.1: Güter die dem Waffengesetz unterliegen
* 5.2: Zivile Sprengstoffe
* ChKV: Chemikalien der Chemikalienkontrollverordnung
* GKV: Güter des Anhangs 1 + 2 der Güterkontrollverordnung, sogenannte "Dual-Use-Güter"
* ML (GKV): "Besondere militärische Güter", ebenfalls Teil der GKV
* unbekannt 

Die in der Visualisierung mit hochgestellten Buchstaben referenzierte Zusammenfassung der Verzeichnisse ("Dual-Use-Güter", "Besondere militärische Güter" und "Andere Güter") wurde von SRF Data vorgenommen und ist unter `output/verzeichnis_beschreibung.csv` einsehbar. 

#### Attribut *Haupttyp*

Die in der Visualisierung dargestellte "Kategorie" entspricht dem *Haupttyp*. Die Übersetzung von *Haupttyp* wurde von SRF Data basierend auf amtlichen Dokumenten (Verordnungen, Verzeichnisse) vorgenommen und ist unter `output/signatures_verzeichnis_haupttyp_beschreibung.csv` einsehbar. 

#### Beispiel Signaturaufschlüsselung

GKV 6A002.c1 ergibt...

* *Haupttyp*: 6 ("Sensoren und Laser")
* *Untertyp*: A ("Ausrüstungen, Baugruppen, Bestandteile")
* *Zusatz*: 002.c1

In der Gesamtheit: "Ausrüstung zur 'direkten Bildwandlung' mit eingebauten Bildverstärkerröhren" (gemäss Anhang 1 + 2 GKV, 2012).

#### Originalquelle

Der Datensatz für die Jahre 2012, 2013 und 2014 basiert ursprünglich auf zwei verschiedenen, von SECO im Januar 2015 publizierten Datensätzen: 

* Tracker: [SECO Tracker Applikation](https://www.seco.admin.ch/dam/seco/de/dokumente/Aussenwirtschaft/Wirtschaftsbeziehungen/Exportkontrollen/Industrieprodukte/Statistik/Statistik%20Dual-Use%20Jan.%202012%20-%20Sep.%202014%20Tracker.xlsx.download.xlsx/Statistik%20Dual-Use%20Jan.%202012%20-%20Sep.%202014%20Tracker.xlsx) -> im Ordner `input/tracker.xlsx`

* ELIC: [SECO ELIC](https://www.seco.admin.ch/dam/seco/de/dokumente/Aussenwirtschaft/Wirtschaftsbeziehungen/Exportkontrollen/Industrieprodukte/Statistik/Statistik%20Dual-Use%202014%20Elic.xlsx.download.xlsx/Statistik%20Dual-Use%202014%20Elic.xlsx) -> im Ordner `input/elic.xlsx`

Der Datensatz für das Jahr 2015 findet sich auf der neuen [Übersichtsseite](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html) unter dem Reiter 2015 -> im Ordner `input/elic_2015_new.xlsx`.

Der Datensatz für das Jahr 2016 und das Jahr 2017 findet sich auf der neuen [Übersichtsseite](https://www.seco.admin.ch/seco/de/home/Aussenwirtschaftspolitik_Wirtschaftliche_Zusammenarbeit/Wirtschaftsbeziehungen/exportkontrollen-und-sanktionen/industrieprodukte--dual-use--und-besondere-militaerische-gueter/statistik/2015.html) unter dem Reiter 2016 bzw. 2017. Er ist jeweils auf vier Excel-Files (für jedes Quartal) aufgesplittet.


### Hinweis zu Mehrfachbewilligungen

Laut Aussage des SECO kann die veröffentlichte Bewilligungs-Datenbank Mehrfachbewilligungen enthalten. Gewisse Aufträge sind so umfassend, dass ihre Ausführung mehrere Jahre dauert. Weil eine Exportbewilligung aber nur ein Jahr gültig ist, tauchen in den Daten vereinzelt auch Geschäfte auf, die schon vor 2012 bewilligt wurden. Solche Mehrfachbewilligungen führen dazu, dass Aufträge in der Statistik mehrfach vorkommen können.

Vom SECO wurde SRF Data eine Liste mit Geschäften übergeben, die schon vor 2012 erstmals bewilligt wurden und ihren Weg wiederum in die Datenbank fanden. Es handelt sich um folgende Geschäftsnummern:

| Geschäftsnummer | Beschreibung | Auftragsvolumen |
|-------|------|---------|
| 8001226 (ELIC) | Flugzeuge und Simulatoren nach Indien | rund 155 Mio. CHF |
| 14476 | Flugzeuge nach Indien | rund 165 Mio. CHF |
| 16043 | Flugzeuge nach Indien | rund 80 Mio. CHF |
| 12332 | Flugzeuge nach Saudi-Arabien | rund 1 Mia. CHF |
| 8001302 (ELIC) | Simulatoren nach Katar |rund 345 Mio. CHF |

Für die Jahre 2015, 2016 und 2017 liegen keine solchen Informationen vor.

## Vorbereitungen

```{r preparations, echo=FALSE}
detach_all_packages <- function() {
  basic_packages_blank <-  c("stats",
                             "graphics",
                             "grDevices",
                             "utils",
                             "datasets",
                             "methods",
                             "base")
  basic_packages <- paste("package:", basic_packages_blank, sep = "")

  package_list <- search()[
    ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

  package_list <- setdiff(package_list, basic_packages)

  if (length(package_list) > 0)  for (package in package_list) {
    detach(package, character.only = TRUE, unload = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}

detach_all_packages()

# this allows multiple persons to use the same RMarkdown
# without adjusting the working directory by themselves all the time
source("scripts/csf.R")
path_to_wd <- csf() # if this - for some reason - does not work,
# replace with a hardcoded path, like so: "~/projects/rddj-template/analysis/"
if ( is.null(path_to_wd) | !dir.exists(path_to_wd)) {
  print("WARNING: No working directory specified for current user")
} else {
  setwd(path_to_wd)
}

# suppress scientific notation
options(scipen = 999)

# unload global rstudioapi and knitr again to avoid conflicts with checkpoint
# this is only necessary if executed within RStudio
# outside of RStudio, namely in the knit.sh script, this causes RMarkdown
# rendering to fail, thus should not be executed there
if (Sys.getenv("RSTUDIO") == "1"){
  detach_all_packages()
}
```


### Packages definieren

```{r define packages}
# von https://mran.revolutionanalytics.com/web/packages/checkpoint/vignettes/using-checkpoint-with-knitr.html
# alle Packages, die nicht gebraucht werden, können hier entfernt werden (auskommentieren reicht nicht!)
# tidyverse: see https://blog.rstudio.org/2016/09/15/tidyverse-1-0-0/
cat("
library(tidyverse) # ggplot2, dplyr, tidyr, readr, purrr, tibble
library(magrittr) # pipes
library(forcats) # factors
library(stringr) # string manipulation
library(readxl) # excel
library(scales) # scales for ggplot2
library(rmarkdown) # muss für automatisches knitting 
# in deploy.sh eingebunden werden",
file = "manifest.R")
```

### Packages installieren

```{r install packages}
# if checkpoint is not yet installed, install it (for people using this
# system for the first time)
if (!require(checkpoint)) {
  if (!require(devtools)) {
    install.packages("devtools", repos = "http://cran.us.r-project.org")
    require(devtools)
  }
  devtools::install_github("RevolutionAnalytics/checkpoint",
                           ref = "v0.3.2", # could be adapted later,
                           # as of now (beginning of July 2017
                           # this is the current release on CRAN)
                           repos = "http://cran.us.r-project.org")
  require(checkpoint)
}
# nolint start
if (!dir.exists("~/.checkpoint")) {
  dir.create("~/.checkpoint")
}
# nolint end
# install packages for the specified CRAN snapshot date
checkpoint(snapshotDate = package_date,
           project = path_to_wd,
           verbose = T,
           scanForPackages = T,
           use.knitr = F,
           R.version = R_version)
rm(package_date)
```

### Packages laden

```{r load packages}
source("manifest.R")
unlink("manifest.R")
sessionInfo()
```

### Zusätzliche Scripts laden

```{r load scripts}
# falls Logik auf andere Scripts ausgelagert werden soll (z.B. der Übersichtlichkeit halber), hier einkommentieren
knitr::read_chunk("scripts/classify.R")
source("scripts/classify.R")
knitr::read_chunk("scripts/numberFormatter.R")
source("scripts/numberFormatter.R")
```

## Vorprozessierung

### Daten reinladen und typisieren

```{r}
tracker_raw <- read_excel(path = "input/tracker.xlsx", sheet = 1)
# Spaltentypen setzen und umbenennen
tracker_raw <- tracker_raw %>%
  mutate(Bewilligungsdatum = as.Date(Bewilligungsdatum, "%Y-%m-%d"), 
         Geschäftsnummer = as.integer(Geschäftsnummer),
         Wert = as.numeric(Wert), 
         Quartal = paste(format(Bewilligungsdatum, "%y"), 
                  sprintf("%02i", 
                          (as.POSIXlt(Bewilligungsdatum)$mon) %/% 3L + 1L), 
                  sep = "/")) %>%
  rename(GN = Geschäftsnummer, 
         Datum = Bewilligungsdatum, 
         Land = Endverbraucherland)

# überprüfen
str(tracker_raw)

elic_raw <- read_excel(path = "input/elic.xlsx", sheet = 1)
# Spaltentypen setzen und umbenennen
elic_raw <- elic_raw %>%
  mutate(Ausstellungsdatum = as.Date(Ausstellungsdatum, "%d.%m.%Y"),
         Geschäftsnummer = as.integer(Geschäftsnummer), 
         `Position / Wert [CHF]` = 
           as.numeric(`Position / Wert [CHF]`), 
         Quartal = paste(format(Ausstellungsdatum, "%y"), 
                         sprintf("%02i", 
                              (as.POSIXlt(Ausstellungsdatum)$mon) %/% 3L + 1L), 
                  sep = "/")) %>%
  rename(GN = Geschäftsnummer, 
         Datum = Ausstellungsdatum, 
         Land = `Bestimmungs-/Lieferland`, 
         Wert = `Position / Wert [CHF]`)

# überprüfen
str(elic_raw)


# elic 2015
elic_2015 <- read_xlsx(path = "input/elic_2015_new.xlsx", sheet = 1)
# Spaltentypen setzen und umbenennen
elic_2015 <- elic_2015 %>%
  mutate(Ausstellungsdatum = as.Date(Ausstellungsdatum, "%d.%m.%Y"), 
         Geschäftsnummer = as.integer(Geschäftsnummer), 
         `Wert [CHF]` = as.numeric(`Wert [CHF]`), 
         Quartal = paste(format(Ausstellungsdatum, "%y"), 
                         sprintf("%02i", 
                              (as.POSIXlt(Ausstellungsdatum)$mon) %/% 3L + 1L), 
                  sep = "/")) %>%
  rename(GN = Geschäftsnummer, 
         Datum = Ausstellungsdatum, 
         Land = Bestimmungsland, 
         Wert = `Wert [CHF]`, 
         `Position / Güterart` = Güterart, 
         `Position / EKN` = EKN, 
         Art = Geschäftsart) %>% 
  filter(Art == "Ausfuhr") %>% 
  select(-Art)

elic_ab_2016 <- map_dfr(list.files("input/", "elic_\\d{4}_\\d{1}\\.xlsx$"), 
                        function(file){
  # parse file name
  year <- as.numeric(str_match_all(file, 
                                   "elic_(\\d{4})_(\\d{1})\\.xlsx$")[[1]][, 2])
  quart <- as.numeric(str_match_all(file, 
                                    "elic_(\\d{4})_(\\d{1})\\.xlsx$")[[1]][, 3])
  
  month <- (quart - 1) * 3 + 1
  # read in excel
  raw_data <- read_excel(path = paste0("input/", file), sheet = 1)
  data <- raw_data %>% 
    mutate(Datum = as.Date(paste(paste(year, month, "01", sep = "-"), 
                                 "00:00:01"))) %>% 
    mutate(Quartal = paste(format(Datum, "%y"), 
                           sprintf("%02i", 
                                   (as.POSIXlt(Datum)$mon) %/% 3L + 1L), 
                           sep = "/")) %>%
    select(GN = Geschäftsnummer, 
           Datum, 
           Quartal, 
           Land = Bestimmungsland, 
           Wert = `Wert [CHF]`, 
           `Position / Güterart` = Güterart, 
           `Position / EKN` = `Exportkontrollnummer [EKN]`, 
           Art = Richtung) %>% 
  filter(Art == "Ausfuhr") %>% 
  select(-Art)
  return(data)
})

# manuelle Fehlerbehebung: Für EKN 5.3 gibt es keine offizielle Definition, 
# gemeint ist wohl 5.1
elic_ab_2016 %<>%
  mutate(`Position / EKN` = ifelse(GN == 8010868 & `Position / EKN` == 5.3, 
                                   5.1, 
                                   `Position / EKN`))



elic_raw <- rbind(elic_raw, elic_2015, elic_ab_2016)
rm(elic_2015)
rm(elic_ab_2016)
```

### Duplikate 

Duplikate: Mehrere Einträge unter der gleichen Geschäftsnummer

Wie viele "Duplikate" gibt es? 

```{r}
dim(tracker_raw)[1] - dim(distinct(select(tracker_raw, GN)))[1]
dim(elic_raw)[1] - dim(distinct(select(elic_raw, GN)))[1]
```
Diese werden nicht aggregiert sondern so belassen, jedoch durchnummiert (Generierung neue Spalte UnterGN)

```{r}
tracker_summarized <- tracker_raw %>%
  group_by(GN, Quartal, Land) %>%
  mutate(UnterGN = row_number())
elic_summarized <- elic_raw %>%
  group_by(GN, Quartal, Land) %>%
  mutate(UnterGN = row_number())

rm(tracker_raw)
rm(elic_raw)
```


Wie viele Einträge haben in der Tracker-Applikation zwei Signaturen? 
```{r}
tracker_summarized %>% 
  filter(`NSGII (GKV)` != "" & `WA (GKV)` != "") %>% 
  nrow()
```

Wie viele davon sind solche, die mit der gleichen Obersignatur (sprich: dem gleichen Haupt- und Untertyp, siehe unten) beginnen? 
```{r}

tracker_summarized %>% 
  filter(`NSGII (GKV)` != "" & `WA (GKV)` != "" &
           substr(`NSGII (GKV)`, 1, 2) == substr(`WA (GKV)`, 1, 2)) %>% 
  nrow()
```

Wie viele Geschäfte haben keine Signatur? 
```{r}
tracker_without_signature <- tracker_summarized %>% 
  gather(Variable, Value, `AG (GKV)`:
           ChKV) %>% 
  group_by(GN, Quartal, Land, UnterGN) %>%
  filter(all(is.na(Value) | Value == "NA")) %>% 
  slice(1)
dim(tracker_without_signature)[1]
```
ELIC?
```{r}
dim(elic_summarized[elic_summarized$`Position / EKN` == "", ])[1]
```

### Restrukturieren

```{r}
# ELIC: Umbenennen und Spalte hinzufügen
elic_restructured <- elic_summarized %>%
  rename(Signatur = `Position / EKN`, 
         "Verordnung/Typ ELIC" = `Position / Güterart`) %>%
  mutate("Verordnung/Typ" = NA)

# Tracker: Kondensieren (breit nach lang)
tracker_restructured <- tracker_summarized %>% 
  gather(Variable, Value, `AG (GKV)`:ChKV) %>%                        
  group_by(GN, Quartal, Land, UnterGN) %>% 
# wenn Geschäft gar keine Signatur hat, dann nur den ersten nehmen, 
# sonst alle nehmen, die einen Wert haben 
# (für solche, die mehr als eine Signatur haben)
  filter( if (all(is.na(Value) | Value == "NA")) 
    row_number() == 1 
    else (!is.na(Value) | Value == "NA")) %>% 
# alle eindeutigen Werte pro Gruppe mit einem newline-Operator zusammenfügen
  summarise_each(funs(paste(unique(.), collapse = "\n")))  %>%        
  mutate(Wert = as.numeric(Wert))                                     

# Tracker: Einträge, für die keine Signatur bekannt ist, 
# umbenennen, und eine leere Spalte für Kombination 
# mit ELIC hinzufügen, sowie Spalten umbennenen
tracker_restructured <- tracker_restructured %>%
  mutate(Variable = ifelse(is.na(Value) | Value == "NA", "unbekannt", 
                           Variable), 
         Value = ifelse(is.na(Value) | Value == "NA", "unbekannt", Value), 
         "Verordnung/Typ ELIC" = NA) %>%
  rename("Verordnung/Typ" = Variable, "Signatur" = Value)

```

Zwischenbilanz

```{r}
str(as.data.frame(elic_restructured))
str(as.data.frame(tracker_restructured))

rm(tracker_summarized)
rm(elic_summarized)
```

### Beide Datensätze kombinieren

```{r}
seco_dual_use <- rbind(as.data.frame(elic_restructured), 
                       as.data.frame(tracker_restructured))
str(seco_dual_use)

rm(tracker_restructured)
rm(elic_restructured)
```

### Länder-Duplikate entfernen
Wie viele Länder gibt es? 

```{r}
laender <- arrange(seco_dual_use, Land)
# unique(laender$Land) # der Lesbarkeit halber auskommentiert
length(unique(laender$Land))
```

Manuell umschreiben gemäss SRF-Länderliste.

```{r}
seco_dual_use$Land[seco_dual_use$Land == "Bosnien und Herzegowina"] <- 
  "Bosnien-Herzegowina"
seco_dual_use$Land[seco_dual_use$Land == "Georgien, Republik"] <- 
  "Georgien"
seco_dual_use$Land[seco_dual_use$Land == "Pakistan (CA)"] <- 
  "Pakistan"
seco_dual_use$Land[seco_dual_use$Land == "Indien (CA)"] <- 
  "Indien"
seco_dual_use$Land[seco_dual_use$Land == "China, Taiwan"] <- 
  "Taiwan"
seco_dual_use$Land[seco_dual_use$Land == "China, Volksrepublik"] <- 
  "China"
seco_dual_use$Land[seco_dual_use$Land == "Ekuador"] <- 
  "Ecuador"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Großbritannien (Vereinigtes Königreich)"] <- 
  "Grossbritannien"
seco_dual_use$Land[seco_dual_use$Land == "Hongkong"] <- 
  "Hong Kong"
seco_dual_use$Land[seco_dual_use$Land == "Iran, Islamische Republik"] <- 
  "Iran"
seco_dual_use$Land[seco_dual_use$Land == "Iran, Islamische Republik (SG)"] <- 
  "Iran"
seco_dual_use$Land[seco_dual_use$Land == "Myanmar (Union)"] <- 
  "Myanmar (Birma)"
seco_dual_use$Land[seco_dual_use$Land == "Qatar"] <- 
  "Katar"
seco_dual_use$Land[seco_dual_use$Land == "Serbia"] <- 
  "Serbien"
seco_dual_use$Land[seco_dual_use$Land == "Slowakei, Slowakische Republik"] <- 
  "Slowakische Republik"
seco_dual_use$Land[seco_dual_use$Land == "Taiwan, Provinz von China"] <- 
  "Taiwan"
seco_dual_use$Land[seco_dual_use$Land == "Vereinigte Staaten"] <- 
  "Vereinigte Staaten von Amerika"
seco_dual_use$Land[seco_dual_use$Land == "Libysch-Arabische Dschamahirija"] <- 
  "Libyen"
seco_dual_use$Land[seco_dual_use$Land == "Russische Föderation"] <- 
  "Russland"
seco_dual_use$Land[seco_dual_use$Land == "Belarus"] <- 
  "Weissrussland"
seco_dual_use$Land[seco_dual_use$Land == "Bangladesch"] <- 
  "Bangladesh"
seco_dual_use$Land[seco_dual_use$Land == "Bermuda"] <- 
  "Bermudas"
seco_dual_use$Land[seco_dual_use$Land == "Brunei Darussalam"] <- 
  "Brunei"
seco_dual_use$Land[seco_dual_use$Land == "Demokratische Republik Kongo"] <- 
  "Kongo-Kinshasa"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Kongo, Demokratische Republik (ex-Zaire)"] <- 
  "Kongo-Kinshasa"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Kongo, Republik"] <- 
  "Kongo-Kinshasa"
seco_dual_use$Land[seco_dual_use$Land == "Cayman-Inseln"] <- 
  "Kaiman-Inseln"
seco_dual_use$Land[seco_dual_use$Land == "Korea, Republik"] <- 
  "Südkorea"
seco_dual_use$Land[seco_dual_use$Land == "Korea, Republik (Südkorea)"] <- 
  "Südkorea"
seco_dual_use$Land[seco_dual_use$Land == "Kroatien (Hrvatska)"] <- 
  "Kroatien"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Laos, Demokratische Volksrepublik"] <- 
  "Laos"
seco_dual_use$Land[seco_dual_use$Land == "Macao"] <- 
  "Macau"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Mazedonien, die ehemalige jugoslawische Republik"] <- 
  "Mazedonien"
seco_dual_use$Land[seco_dual_use$Land == 
                     "Mazedonien (ehemalige jugoslawische Republik)"] <- 
  "Mazedonien"
seco_dual_use$Land[seco_dual_use$Land == "Myanmar (Birma)"] <- 
  "Myanmar"
seco_dual_use$Land[seco_dual_use$Land == "Slowakische Republik"] <- 
  "Slowakei"
seco_dual_use$Land[seco_dual_use$Land == "Tansania, Vereinigte Republik"] <- 
  "Tansania"
seco_dual_use$Land[seco_dual_use$Land == "Tschechische Republik"] <- 
  "Tschechien"
seco_dual_use$Land[seco_dual_use$Land == "Vereinigte Staaten von Amerika"] <- 
  "USA"
seco_dual_use$Land[seco_dual_use$Land == "Moldova"] <- 
  "Moldawien"

```

Wie viele Länder gibt es jetzt noch? 
```{r}
length(unique(seco_dual_use$Land))
sort(unique(seco_dual_use$Land))
rm(laender)
```

### Kategorisierung

Neue Spalten erstellen
```{r}
# Spalte für Dateiherkunft
seco_dual_use <- seco_dual_use %>%
  mutate(Herkunftsdatei = NA, Verzeichnis = NA, 
         Haupttyp = NA, Untertyp = NA, Zusatz = NA)
```

Signaturaufschlüsselung
```{r}
# Verzeichnis finden
computedList <- mapply(classifyVerzeichnis, seco_dual_use[, "Verordnung/Typ"], 
                       seco_dual_use[, "Verordnung/Typ ELIC"],
                       seco_dual_use[, "Signatur"])

seco_dual_use <- seco_dual_use  %>% 
  mutate(Verzeichnis = as.factor(t(computedList)[, 1]), 
         Herkunftsdatei = as.factor(t(computedList)[, 2]))

# Verordnung/Typ (ELIC) werden nicht mehr gebraucht
seco_dual_use <- seco_dual_use  %>% 
  select(-contains("Verordnung/Typ"))

# Signatur aufschlüsseln
# nur GVK anzeigen
seco_dual_use_only_gkv <- seco_dual_use  %>% 
  filter(Verzeichnis == "GKV") %>%
  select(Signatur, Herkunftsdatei)

computedList <- mapply(classifySignatur, seco_dual_use[, "Verzeichnis"], 
                       seco_dual_use[, "Herkunftsdatei"],
                       seco_dual_use[, "Signatur"])

seco_dual_use_cleaned <- seco_dual_use  %>% 
  mutate(Haupttyp = as.factor(t(computedList)[, 1]), 
         Untertyp = as.factor(t(computedList)[, 2]),
         Zusatz = as.factor(t(computedList)[, 3]))

# Sample nehmen, um Klassifikation zu überprüfen
seco_dual_use_cleaned  %>% 
  sample_n(40) %>%
  select(Verzeichnis, Signatur, Haupttyp, Untertyp, Zusatz)

# Faktorenlevels überprüfen
levels(seco_dual_use_cleaned$Verzeichnis)
levels(seco_dual_use_cleaned$Herkunftsdatei)
# Hier gibt es Einträge à la 1A, 2B und 3B, dies sind keine Fehler, sondern Haupttypen der ChKV
levels(seco_dual_use_cleaned$Haupttyp)
levels(seco_dual_use_cleaned$Untertyp)
levels(seco_dual_use_cleaned$Zusatz)

```


### Plausibilitätsüberprüfungen

Was sind die kleinsten Einträge auf der Liste, das heisst: Wie viele Geschäfte im Wert von 1 Franken gibt es? Wie viele Geschäfte unter 1'000 Franken gibt es? 
Wie viele Geschäfte unter 10'000 Franken gibt es? Wie viele Geschäfte unter 100'000 Franken gibt es? 
```{r}
dim(seco_dual_use_cleaned[seco_dual_use_cleaned$Wert == 1, ])[1]
dim(seco_dual_use_cleaned[seco_dual_use_cleaned$Wert <= 1000, ])[1]
dim(seco_dual_use_cleaned[seco_dual_use_cleaned$Wert <= 10000, ])[1]
dim(seco_dual_use_cleaned[seco_dual_use_cleaned$Wert <= 100000, ])[1]

```

### Output als CSV

```{r}
# Spalten neu ordnen
seco_dual_use_cleaned <- seco_dual_use_cleaned %>%
  select(GN, UnterGN, Quartal, Datum, Land, Wert, Verzeichnis, Signatur,
         Haupttyp, Untertyp, Zusatz, Herkunftsdatei)
# \n durch | ersetzen in Signatur
seco_dual_use_cleaned_for_output <- seco_dual_use_cleaned %>%
  mutate(Signatur = ifelse(Herkunftsdatei == "Tracker", 
                           sub("\\n", "|", Signatur), 
                           sub("\\r\\n", "|", Signatur))) %>%
  mutate(Untertyp = ifelse(is.na(Untertyp), "", as.character(Untertyp))) %>%
  mutate(Haupttyp = ifelse(is.na(Haupttyp), "", as.character(Haupttyp))) %>%
  mutate(Zusatz = ifelse(is.na(Zusatz), "", as.character(Zusatz))) %>% 
  mutate(GN = as.character(GN))
write.csv(seco_dual_use_cleaned_for_output, file = "output/seco_dual_use.csv")

# Output für Visualisierung
# Benötigt: Datum, Land, Wert, Verzeichnis, Haupttyp
seco_dual_use_for_vis <- seco_dual_use_cleaned %>%
  select(Datum, Land, Wert, Verzeichnis, Haupttyp) %>%
  mutate(Haupttyp = as.character(Haupttyp))
# Chemikalien zusammenfassen
seco_dual_use_for_vis$Haupttyp[seco_dual_use_for_vis$Verzeichnis == "ChKV"] <- 
  "0"
# NAs durch leere Strings ersetzen
seco_dual_use_for_vis$Haupttyp[is.na(seco_dual_use_for_vis$Haupttyp)] <- 
  ""
# 
# # Dummy-Daten für letztes Quartal
# seco_dual_use_for_vis %<>%
#   rbind(
#     data.frame(
#       "Datum" = "2017-10-01", 
#       "Land" = "USA", 
#       "Wert" = 1000000,
#       "Verzeichnis" = "GKV", 
#       "Haupttyp" = "2"
#     )
#   )
write.csv(seco_dual_use_for_vis, 
          file = "output/seco_dual_use_for_vis.csv", 
          row.names = F, quote = c(1, 2, 4, 5))
```

Output aller unterschiedlichen Signaturen als CSV
```{r}
write.csv(data.frame(signatures = unique(paste(
  seco_dual_use_cleaned$Verzeichnis, 
  seco_dual_use_cleaned$Haupttyp, 
  seco_dual_use_cleaned$Untertyp, 
  seco_dual_use_cleaned$Zusatz))), "output/all_signatures.csv")
```

Output aller unterschiedlichen Verzeichnis-Haupttyp-Kategorien zur manuellen Beschreibung
```{r}
only_top_category_signatures <- seco_dual_use_cleaned %>%
  select(Verzeichnis, Haupttyp) %>%
  distinct() %>%
  mutate(Beschreibung = "", Haupttyp = as.character(Haupttyp)) %>%
  arrange(Verzeichnis, Haupttyp)
write.csv(only_top_category_signatures, 
          "output/signatures_verzeichnis_haupttyp.csv", row.names = F)
```

## Analyse

### Generelles

Wie sieht die Verteilung aus? 
```{r}
cdf <- ggplot(seco_dual_use_cleaned, aes(x = Wert)) + 
  stat_ecdf() + 
  scale_x_log10(labels = formatAsChfWithoutCHF) + 
  scale_y_continuous(labels = percent)
cdf
```

Wie viel Prozent des Exportvolumens sind Kleinaufträge oder Exporte zu Testzwecken (Definition gemäss SECO: Geschäfte mit einem Wert von unter 10'000 Franken)?
```{r}
seco_dual_use %>%
  group_by("Unter 10'000" = Wert < 10000,
           "Zwischen 10'000 und 100'000" = Wert < 100000 & Wert >= 10000, 
           "Zwischen 100'000 und 1 Mio." = Wert >= 100000 & Wert < 1000000,
           "Zwischen 1 Mio. und 10 Mio." = Wert >= 1000000 & Wert < 10000000,
           "Über 10 Mio." = Wert >= 10000000) %>%
  summarise(Summe = sum(Wert), Anzahl = n()) %>%
  mutate(Summenanteil = Summe / sum(seco_dual_use_cleaned$Wert)) %>%
  gather(Kategorie, Value, -Summe, -Summenanteil, -Anzahl) %>%
  filter(Value == T) %>%
  select(-Value)
# Sonstige Kennzahlen

seco_dual_use %>%
  summarise(median = formatAsChf(median(Wert)), sd = formatAsChf(sd(Wert)), 
            mean = formatAsChf(mean(Wert)))
```

Es zeigt sich klar, dass Exporte mit kleinen Summen nur einen verschwindend kleinen Teil des gesamten Exportvolumens ausmachen (< 2 Prozent). Exporte zu Testzwecken oder temporäre Exporte fallen bei der nachfolgenden Analyse rein rechnerisch also nicht ins Gewicht. Geschäfte mit einem Handelswert von über 10 Mio. sind für rund 60 Prozent des Exportvolumens verantwortlich. 

Exporte im Wert von wie vielen Franken wurden im untersuchten Zeitraum bewilligt? 
```{r}
formatAsChf(sum(seco_dual_use_cleaned$Wert))
```

Was sind die grössten Exporte auf der Liste? 
```{r}
arrange(seco_dual_use_cleaned, desc(Wert)) %>%
  mutate(Wert = formatAsChf(Wert)) %>%
  select(GN, Land, Verzeichnis, Quartal, Wert) %>%
  slice(1:10) 
```

Mit welchen 10 Ländern wird am meisten gehandelt?
```{r}
laenderSummen10Sortiert <- seco_dual_use_cleaned %>%
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(1:10)
laenderAndere <- seco_dual_use_cleaned %>%
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(11:n()) %>%
  summarise(Land = "Andere", Wert = sum(Wert))

# Summe der sonstigen

laenderSummen10SortiertForBar <- rbind(laenderSummen10Sortiert, 
                                       laenderAndere) %>%
  mutate(Land = factor(Land, 
                       levels = c(laenderSummen10Sortiert$Land, 
                                  laenderAndere$Land))) 
# in die richtige Reihenfolge bringen

laenderSummenBar <- ggplot(data = laenderSummen10SortiertForBar, 
                           aes(x = Land, y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Land") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
laenderSummenBar
```

Mit welchen 10 Ländern wird am meisten gehandelt, 2017?
```{r}
laenderSummen10Sortiert <- seco_dual_use_cleaned %>%
  filter(Datum >= as.Date("2017-01-01")) %>% 
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(1:10)
laenderAndere <- seco_dual_use_cleaned %>%
  filter(Datum >= as.Date("2017-01-01")) %>% 
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(11:n()) %>%
  summarise(Land = "Andere", Wert = sum(Wert))

# Summe der sonstigen

laenderSummen10SortiertForBar <- 
  rbind(laenderSummen10Sortiert, laenderAndere) %>%
  mutate(Land = factor(Land, 
                       levels = c(laenderSummen10Sortiert$Land, 
                                  laenderAndere$Land))) 
# in die richtige Reihenfolge bringen

laenderSummenBar <- ggplot(data = laenderSummen10SortiertForBar, 
                           aes(x = Land, y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Land") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
laenderSummenBar
```

Wie viel Prozent des Exportvolumens fallen auf die 5 Länder mit dem grössten bewilligten Exportvolumen? 
```{r}
laenderSummen5Sortiert <- seco_dual_use_cleaned %>%
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(1:5)
sum(laenderSummen5Sortiert$Wert) / sum(seco_dual_use_cleaned$Wert) * 100
```


Wie verteilt sich das Exportvolumen auf die einzelnen Verzeichnisse? 
```{r}
verzeichnisSummen <- seco_dual_use_cleaned  %>% 
  group_by(Verzeichnis) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  mutate(Verzeichnis = factor(Verzeichnis, levels = Verzeichnis))
verzeichnisSummenBar <- ggplot(data = verzeichnisSummen, 
                               aes(x = Verzeichnis, y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Verzeichnis") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
verzeichnisSummenBar
```

### Temporale Auswertung

#### Summe nach Jahr
```{r}
# Summe nach Jahr
exportvolumenNachJahr <- seco_dual_use_cleaned  %>% 
  group_by(Jahr = format(Datum, "%Y"), Verzeichnis) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Verzeichnis = factor(Verzeichnis, levels = c("ML (GKV)", "GKV", 
                                                      "unbekannt", 
                                                      "ChKV", "5.1", "5.2")))

exportvolumenNachJahrBar <- ggplot(data = exportvolumenNachJahr, 
                                   aes(x = Jahr, 
                                       y = Wert, 
                                       fill = factor(Verzeichnis), 
                                       order = Verzeichnis)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr") +
  scale_fill_discrete(name = "Verzeichnis")
  
exportvolumenNachJahrBar
```

#### Summe nach Jahr, nur Irak
```{r}
# Summe nach Jahr
exportvolumenNachJahr <- seco_dual_use_cleaned  %>% 
  filter(Land == "Irak") %>% 
  group_by(Jahr = format(Datum, "%Y"), Verzeichnis) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Verzeichnis = factor(Verzeichnis, 
                              levels = c("ML (GKV)", "GKV", 
                                         "unbekannt", "ChKV", "5.1", "5.2")))

exportvolumenNachJahrBar <- ggplot(data = exportvolumenNachJahr, 
                                   aes(x = Jahr, 
                                       y = Wert, 
                                       fill = factor(Verzeichnis), 
                                       order = Verzeichnis)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr") +
  scale_fill_discrete(name = "Verzeichnis")
  
exportvolumenNachJahrBar
```

#### Summe nach Quartal

```{r}
seco_dual_use_cleaned_with_quarter <- seco_dual_use_cleaned %>% 
  mutate(quarter = ceiling(as.integer(format(Datum, format = "%m")) / 3))

exportvolumenNachQuartal <- seco_dual_use_cleaned  %>% 
  group_by(Quartal = paste(format(Datum, format = "%Y"), 
                           ceiling(as.integer(format(Datum, 
                                                     format = "%m")) / 3), 
                           sep = "-"), 
           Verzeichnis) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Verzeichnis = factor(Verzeichnis, 
                              levels = c("ML (GKV)", "GKV", 
                                         "unbekannt", "ChKV", "5.1", "5.2")))

exportvolumenNachQuartalBar <- ggplot(data = exportvolumenNachQuartal, 
                                      aes(x = Quartal, 
                                          y = Wert, 
                                          fill = factor(Verzeichnis), 
                                          order = Verzeichnis)) +
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Quartal") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_discrete(name = "Verzeichnis")
  
exportvolumenNachQuartalBar

```

#### Nur besondere militärische Güter (ML)

```{r}
# Summe nach Jahr, nur Wassenaar-Güter
# zuerst brauchen wir die grössten fünf Kategorien
exportvolumenML5Groesste <- seco_dual_use_cleaned %>%
  filter(Verzeichnis == "ML (GKV)") %>%
  group_by(Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  select(Haupttyp) %>%
  slice(1:5)
exportvolumenNachJahrML <- seco_dual_use_cleaned  %>% 
  filter(Verzeichnis == "ML (GKV)") %>%
  group_by(Jahr = format(Datum, "%Y"), Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Haupttyp = ifelse(Haupttyp %in% 
                             as.data.frame(exportvolumenML5Groesste)[, 1], 
                           as.character(Haupttyp), "andere")) %>%
  mutate(Haupttyp = factor(Haupttyp, 
                           levels = c(as.character(
                             as.data.frame(exportvolumenML5Groesste)[, 1]), 
                             "andere")))

exportvolumenNachJahrMLBar <- ggplot(data = exportvolumenNachJahrML, 
                                     aes(x = Jahr, 
                                         y = Wert, 
                                         fill = factor(Haupttyp), 
                                         order = Haupttyp)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr") +
  scale_fill_discrete(name = "Haupttyp")
exportvolumenNachJahrMLBar
```

#### Nur Dual-Use (GKV)

```{r}
# Summe nach Jahr, nur GKV
# zuerst brauchen wir die grössten fünf Kategorien
exportvolumenGKV5Groesste <- seco_dual_use_cleaned %>%
  filter(Verzeichnis == "GKV") %>%
  group_by(Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  select(Haupttyp) %>%
  slice(1:5)
exportvolumenNachJahrGKV <- seco_dual_use_cleaned  %>% 
  filter(Verzeichnis == "GKV") %>%
  group_by(Jahr = format(Datum, "%Y"), Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Haupttyp = ifelse(Haupttyp %in% 
                             as.data.frame(exportvolumenGKV5Groesste)[, 1], 
                           as.character(Haupttyp), "andere")) %>%
  mutate(Haupttyp = factor(Haupttyp, levels = c(as.character(
    as.data.frame(exportvolumenGKV5Groesste)[, 1]), "andere")))

exportvolumenNachJahrGKVBar <- ggplot(data = exportvolumenNachJahrGKV, 
                                      aes(x = Jahr, 
                                          y = Wert, 
                                          fill = factor(Haupttyp), 
                                          order = Haupttyp)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr") +
  scale_fill_discrete(name = "Haupttyp")
exportvolumenNachJahrGKVBar
```

#### Nur Irak

```{r}
# Summe nach Jahr, nur GKV
# zuerst brauchen wir die grössten fünf Kategorien
exportvolumenGKV5Groesste <- seco_dual_use_cleaned %>%
  filter(Verzeichnis == "GKV", Land == "Irak") %>%
  group_by(Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  select(Haupttyp) %>%
  slice(1:5)
exportvolumenNachJahrGKV <- seco_dual_use_cleaned  %>% 
  filter(Verzeichnis == "GKV", Land == "Irak") %>%
  group_by(Jahr = format(Datum, "%Y"), Haupttyp) %>%
  summarise(Wert = sum(Wert)) %>%
  mutate(Haupttyp = ifelse(Haupttyp %in% 
                             as.data.frame(exportvolumenGKV5Groesste)[, 1], 
                           as.character(Haupttyp), "andere")) %>%
  mutate(Haupttyp = factor(Haupttyp, levels = c(as.character(
    as.data.frame(exportvolumenGKV5Groesste)[, 1]), "andere")))

exportvolumenNachJahrGKVBar <- ggplot(data = exportvolumenNachJahrGKV, 
                                      aes(x = Jahr, 
                                          y = Wert, 
                                          fill = factor(Haupttyp), 
                                          order = Haupttyp)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr") +
  scale_fill_discrete(name = "Haupttyp")
exportvolumenNachJahrGKVBar
```

#### Summe nach Jahr, Naher Osten

```{r}
neareastcountries <- c("Kuwait", "Bahrain", "Oman", "Katar", 
                       "Saudi-Arabien", "Vereinigte Arabische Emirate", 
                       "Jemen", "Israel", "Jordanien", "Libanon", 
                       "Syrien", "Ägypten", "Iran", "Türkei", "Irak")

# Summe nach Jahr
exportvolumenNachJahr <- seco_dual_use_cleaned  %>% 
  filter(Land %in% neareastcountries) %>% 
  group_by(Jahr = format(Datum, "%Y")) %>%
  summarise(Wert = sum(Wert))
exportvolumenNachJahrBar <- ggplot(data = exportvolumenNachJahr, 
                                   aes(x = Jahr, y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr")
  
exportvolumenNachJahrBar
```

#### Summe nach Quartal, Naher Osten

```{r}
exportvolumenNachQuartal <- seco_dual_use_cleaned  %>% 
  filter(Land %in% neareastcountries) %>% 
  group_by(Quartal = paste(format(Datum, format = "%Y"), 
                           ceiling(as.integer(format(Datum, 
                                                     format = "%m")) / 3), 
                           sep = "-")) %>%
  summarise(Wert = sum(Wert))
exportvolumenNachQuartalBar <- ggplot(data = exportvolumenNachQuartal, 
                                      aes(x = Quartal, y = Wert)) +
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Quartal") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
  
exportvolumenNachQuartalBar

```

#### Summe nach Quartal, total

```{r}
exportvolumenNachQuartal <- seco_dual_use_cleaned  %>% 
  group_by(Quartal = paste(format(Datum, format = "%Y"), 
                           ceiling(as.integer(format(Datum, 
                                                     format = "%m")) / 3), 
                           sep = "-")) %>%
  summarise(Wert = sum(Wert))
exportvolumenNachQuartalBar <- ggplot(data = exportvolumenNachQuartal, 
                                      aes(x = Quartal, y = Wert)) +
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Quartal") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
  
exportvolumenNachQuartalBar

```



### Spezialauswertung IMSI-Catcher / Überwachungstechnologie

Bis Januar 2015 waren IMSI-Catcher wahrscheinlich vor allem in der Kat. **5A001i** ("Systeme oder Ausrüstung, besonders entwickelt oder geändert für das Abhören und das Verarbeiten der Luftschnittstelle von mobilen Funkdiensten"), weniger noch in der Kat. **5A001f1** ("Vortäuschen der Funktionen von Einrichtungen eines Funkzugangsnetzes (RAN, Radio Access Network)").

Ab Januar 2015 war es dann va. Kat. **5A001f** ("Ausrüstung für das Abhören oder Stören von mobiler Kommunikation sowie Überwachungsausrüstung hierfür").

Im aktuell gültigen Anhang (Mai 2017) ist es immer noch diese Kategorie

#### Filtern

```{r}
imsi_exporte <- seco_dual_use_cleaned %>% 
  filter(Haupttyp == "5" & Untertyp == "A" &
    ((Datum < as.Date("2015-01-01") & (str_detect(Zusatz, "^001i") | 
                                         str_detect(Zusatz, "^001f1"))) | 
       (Datum >= as.Date("2015-01-01") & str_detect(Zusatz, "^001f")
        )
     )
    )
```

```{r}
imsi_exporte %>% arrange(Land, Datum) %>% 
  mutate(Wert = formatAsChf(Wert)) %>% 
  select(Datum, Land, Wert, Signatur)
```

#### Grösste Empfänger, seit 2012

```{r}
laenderSummen10Sortiert <- imsi_exporte %>%
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(1:10)
laenderAndere <- imsi_exporte %>%
  group_by(Land) %>%
  summarise(Wert = sum(Wert)) %>%
  arrange(desc(Wert)) %>%
  slice(11:n()) %>%
  summarise(Land = "Andere", Wert = sum(Wert))

# Summe der sonstigen

laenderSummen10SortiertForBar <- rbind(laenderSummen10Sortiert, 
                                       laenderAndere) %>%
  mutate(Land = factor(Land, 
                       levels = c(laenderSummen10Sortiert$Land, 
                                  laenderAndere$Land))) 
# in die richtige Reihenfolge bringen

laenderSummenBar <- ggplot(data = laenderSummen10SortiertForBar, 
                           aes(x = Land, y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Land") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
laenderSummenBar
```

#### Entwicklung über Zeit

```{r}
exportvolumenNachQuartal <- imsi_exporte  %>% 
  group_by(Quartal = paste(format(Datum, format = "%Y"), 
                           ceiling(as.integer(format(Datum, 
                                                     format = "%m")) / 3), 
                           sep = "-")) %>%
  summarise(Wert = sum(Wert))
exportvolumenNachQuartalBar <- ggplot(data = exportvolumenNachQuartal, 
                                      aes(x = Quartal, y = Wert)) +
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Quartal") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
  
exportvolumenNachQuartalBar
```

```{r}
# Summe nach Jahr
exportvolumenNachJahr <- imsi_exporte %>% 
  group_by(Jahr = format(Datum, "%Y")) %>%
  summarise(Wert = sum(Wert))

exportvolumenNachJahrBar <- ggplot(data = exportvolumenNachJahr, 
                                   aes(x = Jahr, 
                                       y = Wert)) + 
  geom_bar(stat = "identity") + 
  scale_y_continuous(labels = formatAsChf) + 
  xlab("Jahr")
  
exportvolumenNachJahrBar
```

Was sind die grössten Exporte auf der Liste? 
```{r}
arrange(imsi_exporte, desc(Wert)) %>%
  mutate(Wert = formatAsChf(Wert)) %>%
  select(GN, Land, Verzeichnis, Quartal, Wert) %>%
  slice(1:15) 


```

### Ablehnungen gemäss bundesrätlicher Notverordnung

https://www.admin.ch/opc/de/classified-compilation/20150564/index.html#app1ahref0
Gemäss Verordnung vom 13. Mai 2015 kann der Export von Dual-Use-Gütern verweigert werden, wenn Grund zur Annahme besteht, dass:a.) das auszuführende oder das zu vermittelnde Gut von der Endempfängerin oder vom Endempfänger als Repressionsmittel verwendet wird; oder b.) die Übertragung eines Immaterialgutes nach Artikel 1 Buchstabe b oder die Einräumung von Rechten daran mit Bezug auf ein Gut erfolgt, von welchem anzunehmen ist, dass es als Repressionsmittel verwendet wird.

Als Güter zur Internet- und Mobilfunküberwachung gelten die folgenden im Anhang 2 der GKV1 unter den nachstehenden Exportkontrollnummern (EKN) aufgeführten Waren, Technologien und Softwareprodukte:

1.4A005 (Geräte für Betrieb von Intrusion-Software), 4D004 (Software für Betrieb von Intrusion-Software), 4E001 (Intrusion-Software), 5A001.f (IMSI-Catcher), 5A001.j (Internet-Monitoring-Tools), 5A002.a.2 (Systeme, Ausrüstung oder Bestandteil für kryptografische Informationssicherheit);
2.5D001 (Software zur Herstellung, Verwendung oder Enwicklung von 5A001), sofern Software zu den EKN 5A001.f und 5A001.j betroffen ist;
3.5E001 (Technologie zur Herstellung, Verwendung oder Entwicklung von 5A001), sofern Technologie zu den EKN 5A001.f und 5A001.j. betroffen ist;
4.5D002 (Software, die die Eigenschaften von 5A002 besitzt), sofern Software zur EKN 5A002.a.2 betroffen ist;
5.5E002 (Technologie zur Herstellung, Verwendung oder Enwicklung von 5A002), sofern Technologie zur EKN 5A002.a.2 betroffen ist.

Achtung! Leider lässt sich nicht herauslesen, ob bei den Bewilligungen der Punkte 2-5 die Einschränkungen zutreffen. Daher sind auch viele Exportbewilligungen im Dataframe, die nicht unter die Verordnung fallen.

#### Daten einlesen

```{r}
denial_2015 <- read_excel(path = 
                            "input/denials/Denial_IP_2015_Ablehnungen.xlsx", 
                          sheet = 1)
# Spaltentypen setzen und umbenennen
denial_2015 <- denial_2015 %>%
  mutate(Geschäftsnummer = as.integer(Geschäftsnummer),
         Wert = as.numeric(`Wert [CHF]`), 
         Quartal = "15/01") %>%
  rename(GN = Geschäftsnummer, 
         Land = Bestimmungsland,
         Signatur = `Exportkontrollnummer EKN`) %>% 
  select(-`Wert [CHF]`)

denial_ab_2016 <- map_dfr(list.files("input/denials", 
                                     "^\\d{1}.*Quartal.{1}\\d{4}.*\\.xlsx$"), 
                        function(file){
  # parse file name
  quart <- as.numeric(
    str_match_all(file, 
    "^(\\d{1}).*Quartal.{1}\\d{4}.*\\.xlsx$")[[1]][, 2])
  year <- as.numeric(
    str_match_all(file, 
    "^\\d{1}.*Quartal.{1}(\\d{4}).*\\.xlsx$")[[1]][, 2])
  month <- (quart - 1) * 3 + 1
  # read in excel
  raw_data <- read_excel(path = paste0("input/denials/", file), sheet = 1)
  data <- raw_data %>% 
    mutate(Quartal = paste0(str_sub(year, 3), "/0", quart)) %>%
    mutate(as.integer(Geschäftsnummer)) %>% 
    rename_at(vars(contains("EKN")), ~"Signatur") %>% 
    rename_at(vars(starts_with("Ablehnungs")), ~"Ablehnungsgrundlage") %>% 
    select(GN = Geschäftsnummer, 
           Land = Bestimmungsland, 
           Güterart,
           Signatur,
           Ablehnungsgrundlage,
           Wert = `Wert [CHF]`, 
           Quartal
      )
  return(data)
})
denials <- denial_2015 %>% bind_rows(denial_ab_2016)

# print 
denials %>% 
  mutate(Wert = formatAsChf(Wert)) %>% 
  filter(str_detect(Ablehnungsgrundlage, "überwachung")) %>% 
  arrange(Quartal) %>% select(-Ablehnungsgrundlage)
```

Die Tabelle beinhaltet nur Ablehnungen auf Grund von Art. 6 Abs. 1 Bst. a 
der Verordnung über die Ausfuhr und Vermittlung von Gütern zur Internet- und Mobilfunküberwachung.


## Linting

Der Code in diesem RMarkdown wird mit [lintr](https://github.com/jimhester/lintr) automatisch auf den Wickham'schen [tidyverse style guide](http://style.tidyverse.org/) überprüft. 

```{r linting}

lintr::lint("main.Rmd", linters = 
              lintr::with_defaults(
                commented_code_linter = NULL,
                trailing_whitespace_linter = NULL
                )
            )
```

